generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

model Project {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String           @map("user_id") @db.Uuid
  title          String
  description    String?
  coverImage     String?          @map("cover_image")
  createdAt      DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  genre          String?          @db.Text
  coreConflict   String?          @map("core_conflict") @db.Text
  settingsJson   Json?            @map("settings_json") @db.Json
  branches       Branch[]
  chapters       Chapter[]
  characters     Character[]
  worldSettings  WorldSetting[]
  chats          Chat[]
  settingHistory SettingHistory[]
  mode           Mode             @default(novel)

  @@map("projects")
  @@schema("public")
}

enum ChatType {
  plot
  character
  world

  @@schema("public")
}

model Chat {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String        @map("project_id") @db.Uuid
  type      ChatType
  title     String
  createdAt DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages  ChatMessage[]

  @@index([projectId], map: "idx_chats_project_id")
  @@map("chats")
  @@schema("public")
}

model Chapter {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId     String        @map("project_id") @db.Uuid
  title         String
  content       String        @default("")
  panelScript   Json?         @map("panel_script")
  branchId      String?       @map("branch_id") @db.Uuid
  order         Int           @default(0) @map("order")
  isCanon       Boolean?      @default(true) @map("is_canon")
  createdAt     DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?     @default(now()) @map("updated_at") @db.Timestamptz(6)
  baseOf        Branch[]      @relation("BaseChapter")
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  panelMessages ChatMessage[] @relation("ChapterPanelMessages")

  @@index([projectId], map: "idx_chapters_project_id")
  @@index([branchId], map: "idx_chapters_branch_id")
  @@map("chapters")
  @@schema("public")
}

model Branch {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId     String    @map("project_id") @db.Uuid
  name          String
  baseChapterId String?   @map("base_chapter_id") @db.Uuid
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  baseChapter   Chapter?  @relation("BaseChapter", fields: [baseChapterId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([projectId], map: "idx_branches_project_id")
  @@map("branches")
  @@schema("public")
}

model ChatMessage {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId    String    @map("chat_id") @db.Uuid
  role      String
  content   String
  panelId   String?   @map("panel_id") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  panel     Chapter?  @relation("ChapterPanelMessages", fields: [panelId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  chat      Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([chatId], map: "idx_chat_messages_chat_id")
  @@map("chat_messages")
  @@schema("public")
}

model Character {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String    @map("project_id") @db.Uuid
  name      String
  role      String?   @db.Text
  summary   String?   @db.Text
  imageUrl  String?   @map("image_url") @db.Text
  images    Json?     @db.Json
  traits    Json?     @db.Json
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([projectId], map: "idx_characters_project_id")
  @@map("characters")
  @@schema("public")
}

model WorldSetting {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String    @map("project_id") @db.Uuid
  name      String
  traits    Json?
  summary   String?   @db.Text
  images    Json?     @db.Json
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([projectId], map: "idx_world_settings_project_id")
  @@map("world_settings")
  @@schema("public")
}

model SettingHistory {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String    @map("project_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  changes   Json      @db.Json
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([projectId], map: "idx_setting_history_project_id")
  @@map("setting_history")
  @@schema("public")
}

enum Mode {
  novel
  manhwa
  convert

  @@schema("public")
}
